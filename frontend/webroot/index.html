<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        .leftSide {
            width: 500px;
        }

        .leftSideItem {
            float: left;
        }

        .bottomLeftSide {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 500px;
        }

    </style>
</head>
<body>
<script src="js/logger.js"></script>
<script src="js/protobuf.js"></script>
<script src="js/load_protobuf.js"></script>

<div class="leftSide">
    <div class="leftSideItem" style="width: 50%">
        <input type="text" id="token" value="123123" style="width: 100%"/>
    </div>
    <div class="leftSideItem" style="width: 50%">
        <button type="button" id="loginBtn">login</button>
    </div>
</div>
<div class="leftSide">
    <div class="leftSideItem" style="width: 50%">
        <input type="text" id="module" style="width: 100%"/>
    </div>
    <div class="leftSideItem" style="width: 50%">
        <input type="text" id="api" style="width: 100%"/>
    </div>
</div>
<div class="leftSide">
    <div class="leftSideItem" style="width: 100%">
        <textarea id="param" style="width: 100%; height: 200px"></textarea>
    </div>
</div>
<div class="leftSide">
    <div class="leftSideItem">
        <button type="button" id="sendBtn">send</button>
    </div>
    <div class="leftSideItem">
        <button type="button" id="refreshBtn">refresh</button>
    </div>
    <div class="leftSideItem">
        <button type="button" id="closeBtn">close</button>
    </div>
</div>

<div class="bottomLeftSide" id="btnGroup">
</div>

<script>

    var ws;

    var id = 0;

    function connect() {
        if (ws) {
            ws.close();
        }
        ws = new WebSocket("ws:" + location.host + "/v1/h5game/ws");
        ws.binaryType = "arraybuffer";
        ws.onopen = function (ev) {
            console.log("on open");

            ws.onmessage = function (ev) {
                console.log("on msg ->");

                var dd = RPC.decode(ev.data);
                console.log(dd);
            };

            ws.onclose = function (ev) {
                console.log("on close");
            };

        };
    }

    function close() {
        if (ws) {
            ws.close();
            ws = null;
        }
    }

    RPC.init(function (err) {
        if (err) {
            throw err;
        }

        connect();

    });

    document.getElementById("loginBtn").onclick = function () {
        var module = 'x';
        var api = "login";
        var param = '{}';
        var token = document.getElementById("token").value;

        var payload = RPC.buildPayload(++id, module, api, token, JSON.parse(param));
        ws.send(payload);
    };

    document.getElementById("sendBtn").onclick = function () {
        var module = document.getElementById("module").value || 'x';
        var api = document.getElementById("api").value;
        var param = document.getElementById("param").value || '{}';

        var payload = RPC.buildPayload(++id, module, api, '', JSON.parse(param));
        ws.send(payload);
    };

    document.getElementById("refreshBtn").onclick = function () {
        connect();
    };

    document.getElementById("closeBtn").onclick = function () {
        close();
    };

    var btns = [];
    btns.push({
            module: "demo",
            api: "match",
            param: "{\"1\":1}"
        }, {
            module: "demo",
            api: "prepare",
            param: "{\"1\":true}"
        }
    );

    window.onload = function () {
        for (var i in btns) {
            var str = "<button type=\"button\" id=\"btn" + i + "\" onclick='onBtnclick(" + i + ")'>" + btns[i].api + "</button>";
            document.getElementById("btnGroup").innerHTML += str;
        }
    };

    function onBtnclick(index) {

        document.getElementById("module").value = btns[index].module;
        document.getElementById("api").value = btns[index].api;
        document.getElementById("param").value = btns[index].param;
    }

</script>
</body>
</html>